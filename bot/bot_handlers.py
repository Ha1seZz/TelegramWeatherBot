from utils.json_utils import read_json, write_json
from config.config import TELEGRAM_TOKEN
from utils.weather import fetch_weather
from utils.logger import log_message
from telebot import types
import telebot


# –°–æ–∑–¥–∞—ë–º –æ–±—ä–µ–∫—Ç –±–æ—Ç–∞
bot = telebot.TeleBot(TELEGRAM_TOKEN)
# parse_mode="HTML" - –≤—Å–µ —Å–æ–æ–±—â–µ–Ω–∏—è –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞—é—Ç HTML-—Ä–∞–∑–º–µ—Ç–∫—É


@bot.message_handler(commands=['start'])
def start(message):
    """
    –û–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç –∫–æ–º–∞–Ω–¥—É /start ‚Äî –ø—Ä–∏–≤–µ—Ç—Å—Ç–≤—É–µ—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è.
    """
    log_message(message)  # –õ–æ–≥–∏—Ä—É–µ–º –∫–æ–º–∞–Ω–¥—É
    # –ò–º—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è: —Å–Ω–∞—á–∞–ª–∞ username, –∏–Ω–∞—á–µ first_name
    username = message.from_user.username or message.from_user.first_name

    # –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –ø—Ä–∏–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ
    bot.send_message(
        message.chat.id,
        f"üëã –ü—Ä–∏–≤–µ—Ç <b>@{username}!</b>\n"
        "–ù–∞–ø–∏—à–∏ –Ω–∞–∑–≤–∞–Ω–∏–µ –≥–æ—Ä–æ–¥–∞:"
    )

@bot.message_handler(commands=['setcity'])
def setcity(message):
    """
    –û–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç –∫–æ–º–∞–Ω–¥—É /setcity ‚Äî –∑–∞–ø–æ–º–∏–Ω–∞–µ—Ç –≥–æ—Ä–æ–¥ –¥–ª—è —Ä–∞—Å—Å—ã–ª–∫–∏.
    """
    log_message(message)  # –õ–æ–≥–∏—Ä—É–µ–º –∫–æ–º–∞–Ω–¥—É
    # –û—Ç–ø—Ä–∞–≤–ª—è–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ —Å –∫–Ω–æ–ø–∫–æ–π "üõë –û—Å—Ç–∞–Ω–æ–≤–∏—Ç—å"
    bot.send_message(
        message.chat.id,
        "üèô –í–≤–µ–¥–∏—Ç–µ –Ω–∞–∑–≤–∞–Ω–∏–µ –≥–æ—Ä–æ–¥–∞:",
        reply_markup=stop_city_keyboard()  # –ü—Ä–∏–∫—Ä–µ–ø–ª—è–µ–º –∫–ª–∞–≤–∏–∞—Ç—É—Ä—É
        )
    # –†–µ–≥–∏—Å—Ç—Ä–∏—Ä—É–µ–º –æ–±—Ä–∞–±–æ—Ç—á–∏–∫ —Å–ª–µ–¥—É—é—â–µ–≥–æ —Å–æ–æ–±—â–µ–Ω–∏—è –æ—Ç —ç—Ç–æ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
    bot.register_next_step_handler(message, save_city)

def save_city(message):
    """
    –°–æ—Ö—Ä–∞–Ω—è–µ—Ç –≤–≤–µ–¥—ë–Ω–Ω—ã–π –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–º –≥–æ—Ä–æ–¥ –≤ JSON –ø–æ chat_id.
    """
    log_message(message)  # –õ–æ–≥–∏—Ä—É–µ–º –≤–≤–æ–¥ –≥–æ—Ä–æ–¥–∞
    chat_id = str(message.chat.id)  # –ü—Ä–µ–æ–±—Ä–∞–∑—É–µ–º chat_id –≤ —Å—Ç—Ä–æ–∫—É –¥–ª—è –∫–ª—é—á–∞ JSON
    city = message.text.strip().title()  # –£–±–∏—Ä–∞–µ–º –ø—Ä–æ–±–µ–ª—ã –∏ –¥–µ–ª–∞–µ–º –ø–µ—Ä–≤—É—é –±—É–∫–≤—É –≥–æ—Ä–æ–¥–∞ –∑–∞–≥–ª–∞–≤–Ω–æ–π

    # –ü—Ä–æ–≤–µ—Ä–∫–∞ –≥–æ—Ä–æ–¥–∞ —á–µ—Ä–µ–∑ API
    data = fetch_weather(city)  # –ü–æ–ª—É—á–∞–µ–º –ø–æ–≥–æ–¥—É (–µ—Å–ª–∏ –≥–æ—Ä–æ–¥ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç)
    if not data or data.get("cod") != 200:  # –ï—Å–ª–∏ –æ—à–∏–±–∫–∞ –∏–ª–∏ –∫–æ–¥ != 200 (–≥–æ—Ä–æ–¥ –Ω–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç)
        # –û—Ç–ø—Ä–∞–≤–ª—è–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ —Å –∫–Ω–æ–ø–∫–æ–π "üõë –û—Å—Ç–∞–Ω–æ–≤–∏—Ç—å"
        sent = bot.send_message(
            message.chat.id,
            "‚ùå –ì–æ—Ä–æ–¥ –Ω–µ –Ω–∞–π–¥–µ–Ω. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ —Å–Ω–æ–≤–∞:",
            reply_markup=stop_city_keyboard()  # –ü—Ä–∏–∫—Ä–µ–ø–ª—è–µ–º –∫–ª–∞–≤–∏–∞—Ç—É—Ä—É
        )

        # –†–µ–≥–∏—Å—Ç—Ä–∏—Ä—É–µ–º –æ–∂–∏–¥–∞–Ω–∏–µ —Å–ª–µ–¥—É—é—â–µ–≥–æ –≤–≤–æ–¥–∞ –≥–æ—Ä–æ–¥–∞ –Ω–∞ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–Ω–æ–º —Å–æ–æ–±—â–µ–Ω–∏–∏
        bot.register_next_step_handler(sent, save_city)
        return  # –í—ã—Ö–æ–¥–∏–º, —á—Ç–æ–±—ã –Ω–µ –ø—Ä–æ–¥–æ–ª–∂–∞—Ç—å —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ

    # –ï—Å–ª–∏ –≥–æ—Ä–æ–¥ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç: –ß–∏—Ç–∞–µ–º —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–µ –¥–∞–Ω–Ω—ã–µ
    data = read_json("user_cities.json") or {}

    # –ó–∞–ø–∏—Å—ã–≤–∞–µ–º / –û–±–Ω–æ–≤–ª—è–µ–º –≥–æ—Ä–æ–¥
    data[chat_id] = city
    write_json("user_cities.json", data)

    # –ü–æ–¥—Ç–≤–µ—Ä–∂–¥–∞–µ–º —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ
    bot.send_message(
        message.chat.id,
        f"‚úÖ –ì–æ—Ä–æ–¥ <b>{city.title()}</b> —Å–æ—Ö—Ä–∞–Ω—ë–Ω!"
    )

def stop_city_keyboard():
    """
    –°–æ–∑–¥–∞—ë—Ç Inline-–∫–ª–∞–≤–∏–∞—Ç—É—Ä—É —Å –∫–Ω–æ–ø–∫–æ–π "–û—Å—Ç–∞–Ω–æ–≤–∏—Ç—å".
    """
    # –°–æ–∑–¥–∞—ë–º Inline-–∫–ª–∞–≤–∏–∞—Ç—É—Ä—É —Å –∫–Ω–æ–ø–∫–æ–π "–û—Å—Ç–∞–Ω–æ–≤–∏—Ç—å"
    kb = types.InlineKeyboardMarkup()

    # –î–æ–±–∞–≤–ª—è–µ–º –∫–Ω–æ–ø–∫—É "üõë –û—Å—Ç–∞–Ω–æ–≤–∏—Ç—å" –≤ –∫–ª–∞–≤–∏–∞—Ç—É—Ä—É
    kb.add(types.InlineKeyboardButton("üõë –û—Å—Ç–∞–Ω–æ–≤–∏—Ç—å", callback_data="stop_city_input"))
    # callback_data ‚Üí –∑–Ω–∞—á–µ–Ω–∏–µ, –∫–æ—Ç–æ—Ä–æ–µ –ø—Ä–∏–¥—ë—Ç –≤ callback_query_handler –ø—Ä–∏ –Ω–∞–∂–∞—Ç–∏–∏

    # –í–æ–∑–≤—Ä–∞—â–∞–µ–º –≥–æ—Ç–æ–≤—É—é –∫–ª–∞–≤–∏–∞—Ç—É—Ä—É, —á—Ç–æ–±—ã –º–æ–∂–Ω–æ –±—ã–ª–æ –ø—Ä–∏–∫—Ä–µ–ø–∏—Ç—å –µ—ë –∫ —Å–æ–æ–±—â–µ–Ω–∏—é
    return kb

# –î–µ–∫–æ—Ä–∞—Ç–æ—Ä –ª–æ–≤–∏—Ç callback-–∑–∞–ø—Ä–æ—Å—ã (–Ω–µ —Ç–µ–∫—Å—Ç–æ–≤—ã–µ —Å–æ–æ–±—â–µ–Ω–∏—è)
# func=... —Ñ–∏–ª—å—Ç—Ä—É–µ—Ç —Ç–æ–ª—å–∫–æ —Ç–µ –∫–æ–ª–±—ç–∫–∏, —É –∫–æ—Ç–æ—Ä—ã—Ö callback_data == "stop_city_input"
@bot.callback_query_handler(func=lambda c: c.data == "stop_city_input")
def stop_city_input(c):  # –ü–∞—Ä–∞–º–µ—Ç—Ä c ‚Äî —ç—Ç–æ –æ–±—ä–µ–∫—Ç telebot.types.CallbackQuery
    """
    –û–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç –Ω–∞–∂–∞—Ç–∏–µ –Ω–∞ –∫–Ω–æ–ø–∫—É "–û—Å—Ç–∞–Ω–æ–≤–∏—Ç—å" –ø—Ä–∏ –≤–≤–æ–¥–µ –≥–æ—Ä–æ–¥–∞.
    """
    bot.answer_callback_query(c.id)  # –ó–∞–∫—Ä—ã–≤–∞–µ–º –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä –∑–∞–≥—Ä—É–∑–∫–∏ –∫–Ω–æ–ø–∫–∏ ("–ß–∞—Å–∏–∫–∏")

    # –°–Ω–∏–º–∞–µ–º –∑–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞–Ω–Ω—ã–π step_handler –¥–ª—è —ç—Ç–æ–≥–æ —á–∞—Ç–∞
    # –ï—Å–ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –æ—Ç–ø—Ä–∞–≤–∏—Ç —Ç–µ–∫—Å—Ç –ø–æ—Å–ª–µ –Ω–∞–∂–∞—Ç–∏—è ¬´–û—Å—Ç–∞–Ω–æ–≤–∏—Ç—å¬ª, save_city –Ω–µ —Å—Ä–∞–±–æ—Ç–∞–µ—Ç
    bot.clear_step_handler_by_chat_id(c.message.chat.id)

    # –ü—ã—Ç–∞–µ–º—Å—è –∏–∑–º–µ–Ω–∏—Ç—å —Å–æ–æ–±—â–µ–Ω–∏–µ —Å –∫–Ω–æ–ø–∫–æ–π –Ω–∞ —Ç–µ–∫—Å—Ç "–û—Ç–º–µ–Ω–µ–Ω–æ"
    try:
        bot.edit_message_text(
            "üö´ –í–≤–æ–¥ –≥–æ—Ä–æ–¥–∞ –æ—Ç–º–µ–Ω—ë–Ω.",
            c.message.chat.id,
            c.message.message_id
        )
    except Exception:
        # –ï—Å–ª–∏ —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –Ω–µ —É–¥–∞–ª–æ—Å—å (–Ω–∞–ø—Ä–∏–º–µ—Ä, –ø–æ –≤—Ä–µ–º–µ–Ω–∏) ‚Äî –ø—Ä–æ—Å—Ç–æ –æ—Ç–ø—Ä–∞–≤–∏–º –Ω–æ–≤–æ–µ
        bot.send_message(c.message.chat.id, "üö´ –í–≤–æ–¥ –≥–æ—Ä–æ–¥–∞ –æ—Ç–º–µ–Ω—ë–Ω.")

@bot.message_handler(commands=['mycity'])
def mycity(message):
    """
    –û–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç –∫–æ–º–∞–Ω–¥—É /mycity ‚Äî –í—ã–≤–æ–¥–∏—Ç —Å–æ—Ö—Ä–∞–Ω—ë–Ω–Ω—ã–π –≥–æ—Ä–æ–¥ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è.
    """
    log_message(message)  # –õ–æ–≥–∏—Ä—É–µ–º –∫–æ–º–∞–Ω–¥—É

    # –ó–∞–≥—Ä—É–∂–∞–µ–º —Å–ª–æ–≤–∞—Ä—å —Å –≥–æ—Ä–æ–¥–∞–º–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π –∏–∑ —Ñ–∞–π–ª–∞
    # –ï—Å–ª–∏ —Ñ–∞–π–ª –ø—É—Å—Ç–æ–π –∏–ª–∏ –Ω–µ –Ω–∞–π–¥–µ–Ω, –ø–æ–ª—É—á–∞–µ–º –ø—É—Å—Ç–æ–π —Å–ª–æ–≤–∞—Ä—å {}
    data = read_json("user_cities.json") or {}

    # –ü–æ–ª—É—á–∞–µ–º –≥–æ—Ä–æ–¥ –ø–æ chat.id –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
    city = data.get(str(message.chat.id))

    if city:
        # –ï—Å–ª–∏ –≥–æ—Ä–æ–¥ –Ω–∞–π–¥–µ–Ω ‚Äî –æ—Ç–ø—Ä–∞–≤–ª—è–µ–º –µ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é
        bot.send_message(
            message.chat.id,
            f"üèô –í–∞—à —Å–æ—Ö—Ä–∞–Ω—ë–Ω–Ω—ã–π –≥–æ—Ä–æ–¥: <b>{city}</b>"
        )
    else:
        # –ï—Å–ª–∏ –≥–æ—Ä–æ–¥ –Ω–µ –Ω–∞–π–¥–µ–Ω ‚Äî –ø—Ä–æ—Å–∏–º —Å–æ—Ö—Ä–∞–Ω–∏—Ç—å –µ–≥–æ —á–µ—Ä–µ–∑ /setcity
        bot.send_message(
            message.chat.id,
            "‚ö† –£ –≤–∞—Å –µ—â—ë –Ω–µ —Å–æ—Ö—Ä–∞–Ω—ë–Ω –≥–æ—Ä–æ–¥.\n–ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ /setcity –¥–ª—è —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è."
        )

@bot.message_handler(content_types=['text'])
def send_weather(message):
    """
    –û–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç —Ç–µ–∫—Å—Ç–æ–≤—ã–µ —Å–æ–æ–±—â–µ–Ω–∏—è ‚Äî –ø—Ä–∏–Ω–∏–º–∞–µ—Ç –Ω–∞–∑–≤–∞–Ω–∏–µ –≥–æ—Ä–æ–¥–∞,
    –ø–æ–ª—É—á–∞–µ—Ç –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ –ø–æ–≥–æ–¥–µ –∏ –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç –µ—ë –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é.
    """
    log_message(message)  # –õ–æ–≥–∏—Ä—É–µ–º –∫–∞–∂–¥–æ–µ —Ç–µ–∫—Å—Ç–æ–≤–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ
    
    # –ò–∑–≤–ª–µ–∫–∞–µ–º –Ω–∞–∑–≤–∞–Ω–∏–µ –≥–æ—Ä–æ–¥–∞ –∏–∑ —Ç–µ–∫—Å—Ç–∞ –∏ —É–±–∏—Ä–∞–µ–º –ø—Ä–æ–±–µ–ª—ã –ø–æ –∫—Ä–∞—è–º
    city = message.text.strip()
    
    # –ü–æ–ª—É—á–∞–µ–º "—Å—ã—Ä–æ–π" JSON —Å –¥–∞–Ω–Ω—ã–º–∏ –æ –ø–æ–≥–æ–¥–µ –æ—Ç API
    data = fetch_weather(city)

    # –ï—Å–ª–∏ –¥–∞–Ω–Ω—ã—Ö –Ω–µ—Ç –∏–ª–∏ API –≤–µ—Ä–Ω—É–ª –æ—à–∏–±–∫—É - –≤—ã–≤–æ–¥–∏–º —Å–æ–æ–±—â–µ–Ω–∏–µ –æ–± –æ—à–∏–±–∫–µ
    if not data or data.get("cod") != 200:
        bot.reply_to(message, "‚ùå –ì–æ—Ä–æ–¥ —É–∫–∞–∑–∞–Ω –Ω–µ–≤–µ—Ä–Ω–æ –∏–ª–∏ —Å–µ—Ä–≤–µ—Ä –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω!")
        return

    # –û–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ–º –¥–∞–Ω–Ω—ã–µ –æ –ø–æ–≥–æ–¥–µ –≤ —É–¥–æ–±–Ω—ã–π –¥–ª—è –Ω–∞—Å —Ñ–æ—Ä–º–∞—Ç
    weather = get_weather(data)

    # –§–æ—Ä–º–∏—Ä—É–µ–º –∏ –æ—Ç–ø—Ä–∞–≤–ª—è–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ —Å —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–º
    bot.reply_to(message, format_weather_message(city, weather))

def get_weather(weather):
    """
    –ü—Ä–∏–Ω–∏–º–∞–µ—Ç "—Å—ã—Ä–æ–π" JSON —Å –ø–æ–≥–æ–¥–æ–π –æ—Ç API –∏ –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç —Å–ª–æ–≤–∞—Ä—å
    —Å —É–∂–µ –≥–æ—Ç–æ–≤—ã–º–∏ –¥–∞–Ω–Ω—ã–º–∏ –¥–ª—è –≤—ã–≤–æ–¥–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é.
    """
    temp = weather['main']['temp']  # –¢–µ–º–ø–µ—Ä–∞—Ç—É—Ä–∞
    weather_main = weather['weather'][0]['main']  # –û—Å–Ω–æ–≤–Ω–æ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ –ø–æ–≥–æ–¥—ã (Rain, Clear –∏ —Ç.–¥.)
    weather_description = weather['weather'][0]['description']  # –û–ø–∏—Å–∞–Ω–∏–µ –ø–æ–≥–æ–¥—ã –Ω–∞ —Ä—É—Å—Å–∫–æ–º (–Ω–∞–ø—Ä–∏–º–µ—Ä, "–ø–∞—Å–º—É—Ä–Ω–æ")
    humidity = weather['main']['humidity']  # –í–ª–∞–∂–Ω–æ—Å—Ç—å –≤–æ–∑–¥—É—Ö–∞ (%)
    wind_speed = weather['wind']['speed']  # –°–∫–æ—Ä–æ—Å—Ç—å –≤–µ—Ç—Ä–∞ (–º/—Å)

    return {
        "temp": temp,                      # –¢–µ–º–ø–µ—Ä–∞—Ç—É—Ä–∞
        "weather_main": weather_main,      # –û—Å–Ω–æ–≤–Ω–æ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ (Rain, Snow, Clear...)
        "weather_description": weather_description,  # –û–ø–∏—Å–∞–Ω–∏–µ –ø–æ–≥–æ–¥—ã
        "humidity": humidity,              # –í–ª–∞–∂–Ω–æ—Å—Ç—å (%)
        "wind_speed": wind_speed           # –°–∫–æ—Ä–æ—Å—Ç—å –≤–µ—Ç—Ä–∞ (–º/—Å)
    }

def format_weather_message(city: str, weather: dict) -> str:
    """
    –§–æ—Ä–º–∏—Ä—É–µ—Ç —Ç–µ–∫—Å—Ç–æ–≤–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ –æ –ø–æ–≥–æ–¥–µ —Å —ç–º–æ–¥–∑–∏.
    """
    # –°–æ–ø–æ—Å—Ç–∞–≤–ª–µ–Ω–∏–µ —Ç–∏–ø–æ–≤ –ø–æ–≥–æ–¥—ã —Å —ç–º–æ–¥–∑–∏
    emoji_map = {
        "Thunderstorm": "‚õàÔ∏è",
        "Drizzle": "üå¶Ô∏è",
        "Rain": "üåßÔ∏è",
        "Snow": "‚ùÑÔ∏è",
        "Atmosphere": "üå´Ô∏è",
        "Clear": "‚òÄÔ∏è",
        "Clouds": "‚òÅÔ∏è"
    }

    emoji = emoji_map.get(weather["weather_main"], "üåç")  # –≠–º–æ–¥–∑–∏ –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é ‚Äî –ø–ª–∞–Ω–µ—Ç–∞
    
    return (
        f"–í –≥–æ—Ä–æ–¥–µ <b>{city}</b> {weather['weather_description']}, {weather['temp']}¬∞C {emoji}\n"
        f"üíß –í–ª–∞–∂–Ω–æ—Å—Ç—å: {weather['humidity']}%, üí® –í–µ—Ç–µ—Ä: {weather['wind_speed']} –º/—Å"
    )
