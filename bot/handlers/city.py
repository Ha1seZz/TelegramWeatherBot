from utils.weather import fetch_weather, is_valid_weather_response
from bot.dependencies import user_cities_json
from bot.keyboards import stop_city_keyboard


def register_city_handlers(bot):
    @bot.message_handler(commands=['setcity'])
    def setcity(message):
        """
        –û–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç –∫–æ–º–∞–Ω–¥—É /setcity ‚Äî –∑–∞–ø–æ–º–∏–Ω–∞–µ—Ç –≥–æ—Ä–æ–¥ –¥–ª—è —Ä–∞—Å—Å—ã–ª–∫–∏.
        """
        # –û—Ç–ø—Ä–∞–≤–ª—è–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ —Å –∫–Ω–æ–ø–∫–æ–π "üõë –û—Å—Ç–∞–Ω–æ–≤–∏—Ç—å"
        bot.send_message(
            message.chat.id,
            "üèô –í–≤–µ–¥–∏—Ç–µ –Ω–∞–∑–≤–∞–Ω–∏–µ –≥–æ—Ä–æ–¥–∞:",
            reply_markup=stop_city_keyboard()  # –ü—Ä–∏–∫—Ä–µ–ø–ª—è–µ–º –∫–ª–∞–≤–∏–∞—Ç—É—Ä—É
            )
        # –†–µ–≥–∏—Å—Ç—Ä–∏—Ä—É–µ–º –æ–±—Ä–∞–±–æ—Ç—á–∏–∫ —Å–ª–µ–¥—É—é—â–µ–≥–æ —Å–æ–æ–±—â–µ–Ω–∏—è –æ—Ç —ç—Ç–æ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
        bot.register_next_step_handler(message, save_city)

    def save_city(message):
        """
        –°–æ—Ö—Ä–∞–Ω—è–µ—Ç –≤–≤–µ–¥—ë–Ω–Ω—ã–π –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–º –≥–æ—Ä–æ–¥ –≤ JSON –ø–æ chat_id.
        """
        chat_id = str(message.chat.id)  # –ü—Ä–µ–æ–±—Ä–∞–∑—É–µ–º chat_id –≤ —Å—Ç—Ä–æ–∫—É –¥–ª—è –∫–ª—é—á–∞ JSON
        city = message.text.strip().title()  # –£–±–∏—Ä–∞–µ–º –ø—Ä–æ–±–µ–ª—ã –∏ –¥–µ–ª–∞–µ–º –ø–µ—Ä–≤—É—é –±—É–∫–≤—É –≥–æ—Ä–æ–¥–∞ –∑–∞–≥–ª–∞–≤–Ω–æ–π

        # –ü—Ä–æ–≤–µ—Ä–∫–∞ –≥–æ—Ä–æ–¥–∞ —á–µ—Ä–µ–∑ API
        data = fetch_weather(city)  # –ü–æ–ª—É—á–∞–µ–º –ø–æ–≥–æ–¥—É (–µ—Å–ª–∏ –≥–æ—Ä–æ–¥ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç)
        if not is_valid_weather_response(data):  # –ï—Å–ª–∏ –æ—Ç–≤–µ—Ç –Ω–µ–≤–µ—Ä–Ω—ã–π (–≥–æ—Ä–æ–¥ –Ω–µ –Ω–∞–π–¥–µ–Ω, –æ—à–∏–±–∫–∞ —Å–µ—Ä–≤–µ—Ä–∞)
            # –û—Ç–ø—Ä–∞–≤–ª—è–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ —Å –∫–Ω–æ–ø–∫–æ–π "üõë –û—Å—Ç–∞–Ω–æ–≤–∏—Ç—å"
            sent = bot.send_message(
                message.chat.id,
                "‚ùå –ì–æ—Ä–æ–¥ –Ω–µ –Ω–∞–π–¥–µ–Ω. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ —Å–Ω–æ–≤–∞:",
                reply_markup=stop_city_keyboard()  # –ü—Ä–∏–∫—Ä–µ–ø–ª—è–µ–º –∫–ª–∞–≤–∏–∞—Ç—É—Ä—É
            )

            # –†–µ–≥–∏—Å—Ç—Ä–∏—Ä—É–µ–º –æ–∂–∏–¥–∞–Ω–∏–µ —Å–ª–µ–¥—É—é—â–µ–≥–æ –≤–≤–æ–¥–∞ –≥–æ—Ä–æ–¥–∞ –Ω–∞ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–Ω–æ–º —Å–æ–æ–±—â–µ–Ω–∏–∏
            bot.register_next_step_handler(sent, save_city)
            return  # –í—ã—Ö–æ–¥–∏–º, —á—Ç–æ–±—ã –Ω–µ –ø—Ä–æ–¥–æ–ª–∂–∞—Ç—å —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ

        # –ï—Å–ª–∏ –≥–æ—Ä–æ–¥ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç: –ß–∏—Ç–∞–µ–º —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–µ –¥–∞–Ω–Ω—ã–µ
        data = user_cities_json.read_json() or {}

        # –ó–∞–ø–∏—Å—ã–≤–∞–µ–º / –û–±–Ω–æ–≤–ª—è–µ–º –≥–æ—Ä–æ–¥
        data[chat_id] = city
        user_cities_json.write_json(data)

        # –ü–æ–¥—Ç–≤–µ—Ä–∂–¥–∞–µ–º —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ
        bot.send_message(
            message.chat.id,
            f"‚úÖ –ì–æ—Ä–æ–¥ <b>{city.title()}</b> —Å–æ—Ö—Ä–∞–Ω—ë–Ω!"
        )

    # –î–µ–∫–æ—Ä–∞—Ç–æ—Ä –ª–æ–≤–∏—Ç callback-–∑–∞–ø—Ä–æ—Å—ã (–Ω–µ —Ç–µ–∫—Å—Ç–æ–≤—ã–µ —Å–æ–æ–±—â–µ–Ω–∏—è)
    # func=... —Ñ–∏–ª—å—Ç—Ä—É–µ—Ç —Ç–æ–ª—å–∫–æ —Ç–µ –∫–æ–ª–±—ç–∫–∏, —É –∫–æ—Ç–æ—Ä—ã—Ö callback_data == "stop_city_input"
    @bot.callback_query_handler(func=lambda c: c.data == "stop_city_input")
    def stop_city_input(c):  # –ü–∞—Ä–∞–º–µ—Ç—Ä c ‚Äî —ç—Ç–æ –æ–±—ä–µ–∫—Ç telebot.types.CallbackQuery
        """
        –û–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç –Ω–∞–∂–∞—Ç–∏–µ –Ω–∞ –∫–Ω–æ–ø–∫—É "–û—Å—Ç–∞–Ω–æ–≤–∏—Ç—å" –ø—Ä–∏ –≤–≤–æ–¥–µ –≥–æ—Ä–æ–¥–∞.
        """
        bot.answer_callback_query(c.id)  # –ó–∞–∫—Ä—ã–≤–∞–µ–º –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä –∑–∞–≥—Ä—É–∑–∫–∏ –∫–Ω–æ–ø–∫–∏ ("–ß–∞—Å–∏–∫–∏")

        # –°–Ω–∏–º–∞–µ–º –∑–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞–Ω–Ω—ã–π step_handler –¥–ª—è —ç—Ç–æ–≥–æ —á–∞—Ç–∞
        # –ï—Å–ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –æ—Ç–ø—Ä–∞–≤–∏—Ç —Ç–µ–∫—Å—Ç –ø–æ—Å–ª–µ –Ω–∞–∂–∞—Ç–∏—è ¬´–û—Å—Ç–∞–Ω–æ–≤–∏—Ç—å¬ª, save_city –Ω–µ —Å—Ä–∞–±–æ—Ç–∞–µ—Ç
        bot.clear_step_handler_by_chat_id(c.message.chat.id)

        # –ü—ã—Ç–∞–µ–º—Å—è –∏–∑–º–µ–Ω–∏—Ç—å —Å–æ–æ–±—â–µ–Ω–∏–µ —Å –∫–Ω–æ–ø–∫–æ–π –Ω–∞ —Ç–µ–∫—Å—Ç "–û—Ç–º–µ–Ω–µ–Ω–æ"
        try:
            bot.edit_message_text(
                "üö´ –í–≤–æ–¥ –≥–æ—Ä–æ–¥–∞ –æ—Ç–º–µ–Ω—ë–Ω.",
                c.message.chat.id,
                c.message.message_id
            )
        except Exception:
            # –ï—Å–ª–∏ —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –Ω–µ —É–¥–∞–ª–æ—Å—å (–Ω–∞–ø—Ä–∏–º–µ—Ä, –ø–æ –≤—Ä–µ–º–µ–Ω–∏) ‚Äî –ø—Ä–æ—Å—Ç–æ –æ—Ç–ø—Ä–∞–≤–∏–º –Ω–æ–≤–æ–µ
            bot.send_message(c.message.chat.id, "üö´ –í–≤–æ–¥ –≥–æ—Ä–æ–¥–∞ –æ—Ç–º–µ–Ω—ë–Ω.")

    @bot.message_handler(commands=['mycity'])
    def mycity(message):
        """
        –û–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç –∫–æ–º–∞–Ω–¥—É /mycity ‚Äî –í—ã–≤–æ–¥–∏—Ç —Å–æ—Ö—Ä–∞–Ω—ë–Ω–Ω—ã–π –≥–æ—Ä–æ–¥ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è.
        """
        # –ó–∞–≥—Ä—É–∂–∞–µ–º —Å–ª–æ–≤–∞—Ä—å —Å –≥–æ—Ä–æ–¥–∞–º–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π –∏–∑ —Ñ–∞–π–ª–∞
        # –ï—Å–ª–∏ —Ñ–∞–π–ª –ø—É—Å—Ç–æ–π –∏–ª–∏ –Ω–µ –Ω–∞–π–¥–µ–Ω, –ø–æ–ª—É—á–∞–µ–º –ø—É—Å—Ç–æ–π —Å–ª–æ–≤–∞—Ä—å {}
        data = user_cities_json.read_json() or {}

        # –ü–æ–ª—É—á–∞–µ–º –≥–æ—Ä–æ–¥ –ø–æ chat.id –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
        city = data.get(str(message.chat.id))

        if city:
            # –ï—Å–ª–∏ –≥–æ—Ä–æ–¥ –Ω–∞–π–¥–µ–Ω ‚Äî –æ—Ç–ø—Ä–∞–≤–ª—è–µ–º –µ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é
            bot.send_message(
                message.chat.id,
                f"üèô –í–∞—à —Å–æ—Ö—Ä–∞–Ω—ë–Ω–Ω—ã–π –≥–æ—Ä–æ–¥: <b>{city}</b>"
            )
        else:
            # –ï—Å–ª–∏ –≥–æ—Ä–æ–¥ –Ω–µ –Ω–∞–π–¥–µ–Ω ‚Äî –ø—Ä–æ—Å–∏–º —Å–æ—Ö—Ä–∞–Ω–∏—Ç—å –µ–≥–æ —á–µ—Ä–µ–∑ /setcity
            bot.send_message(
                message.chat.id,
                "‚ö† –£ –≤–∞—Å –µ—â—ë –Ω–µ —Å–æ—Ö—Ä–∞–Ω—ë–Ω –≥–æ—Ä–æ–¥.\n–ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ /setcity –¥–ª—è —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è."
            )
